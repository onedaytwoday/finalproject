<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="class">
	<select id="selectList" resultType="classDto">
		SELECT CLASS_NO, CLASS_TITLE, CLASS_DESC, CLASS_LOC, CLASS_CATEGORY, CLASS_PRICE, CLASS_SALE, MEMBER_ID
		FROM CLASS
		ORDER BY CLASS_NO DESC
	</select>
	
	<select id="classList" parameterType="PagingDto" resultType="classDto">
		SELECT X.rnum,
		X.CLASS_NO, X.CLASS_TITLE, X.CLASS_DESC, X.CLASS_LOC, X.CLASS_CATEGORY, X.CLASS_PRICE, X.CLASS_SALE, X.MEMBER_ID
		FROM (
		SELECT ROWNUM AS rnum,
		A.CLASS_NO, A.CLASS_TITLE, A.CLASS_DESC, A.CLASS_LOC, A.CLASS_CATEGORY, A.CLASS_PRICE, A.CLASS_SALE, A.MEMBER_ID
		FROM (
		SELECT
		C.CLASS_NO, C.CLASS_TITLE, C.CLASS_DESC, C.CLASS_LOC, C.CLASS_CATEGORY, C.CLASS_PRICE, C.CLASS_SALE, C.MEMBER_ID
		FROM CLASS c
		ORDER BY CLASS_NO DESC
		) A
		WHERE ROWNUM <![CDATA[ <= ]]>
		#{pageEnd}
		) X
		WHERE X.rnum <![CDATA[ >= ]]>
		#{pageBegin}
	</select>
	
	<select id="selectOne" resultType="classDto">
		SELECT CLASS_NO, CLASS_TITLE, CLASS_DESC, CLASS_LOC, CLASS_CATEGORY, CLASS_PRICE, CLASS_SALE, MEMBER_ID
		FROM CLASS
		WHERE CLASS_NO = #{class_no}
	</select>
	
	<select id="selectOneByTitle" resultType="classDto">
		SELECT CLASS_NO, CLASS_TITLE, CLASS_DESC, CLASS_LOC, CLASS_CATEGORY, CLASS_PRICE, CLASS_SALE, MEMBER_ID
		FROM CLASS
		WHERE CLASS_TITLE = #{class_title}
	</select>
	
	<select id="userClass" resultType="classDto">
		SELECT C.CLASS_NO, C.CLASS_TITLE, C.CLASS_DESC, C.CLASS_LOC, C.CLASS_CATEGORY, C.CLASS_PRICE, C.CLASS_SALE, C.MEMBER_ID
		FROM CLASS C, PAYMENT P, DETAIL D
		WHERE D.DETAIL_NO = P.DETAIL_NO AND C.CLASS_NO = D.CLASS_NO AND P.MEMBER_ID = #{member_id}
	</select>
	
	<insert id="insert" parameterType="classDto">
		INSERT INTO CLASS
		VALUES(CLASS_NO_SEQ.NEXTVAL, #{class_title}, #{class_desc}, #{class_loc}, #{class_category}, #{class_price}, #{class_sale}, #{member_id})
		<selectKey keyProperty="class_no" resultType="int" >
			SELECT CLASS_NO_SEQ.CURRVAL From DUAL
		</selectKey>
	</insert>
	
	<update id="update" parameterType="classDto">
		UPDATE CLASS
		SET CLASS_TITLE = #{class_title}, CLASS_DESC = #{class_desc}, CLASS_LOC = #{class_loc}, CLASS_PRICE = #{class_price}, CLASS_SALE = #{class_sale} 
		WHERE CLASS_NO = #{class_no}
	</update>
	
	<update id="updateSale" parameterType="classDto">
		UPDATE CLASS
		SET CLASS_SALE = #{class_sale}
		WHERE CLASS_NO = #{class_no}
	</update>
	
	<delete id="delete">
		DELETE FROM CLASS
		WHERE CLASS_NO = #{class_no}
	</delete>
	
	<select id="classCount" resultType="int">
		SELECT COUNT(CLASS_NO)
		FROM CLASS
	</select>
	
	<select id="classListPaging">
		SELECT X.rnum,
		X.CLASS_NO, X.CLASS_TITLE, X.CLASS_DESC, X.CLASS_LOC, X.CLASS_CATEGORY, X.CLASS_PRICE,
		X.CLASS_SALE, X.MEMBER_ID, X.FILE_NEW_NAME
		FROM (
			SELECT anum AS rnum,
			A.CLASS_NO, A.CLASS_TITLE, A.CLASS_DESC, A.CLASS_LOC, A.CLASS_CATEGORY, A.CLASS_PRICE,
			A.CLASS_SALE, A.MEMBER_ID, A.FILE_NEW_NAME
			FROM (
				SELECT ROWNUM as anum,
				B.CLASS_NO, B.CLASS_TITLE, B.CLASS_DESC, B.CLASS_LOC, B.CLASS_CATEGORY, B.CLASS_PRICE,
				B.CLASS_SALE, B.MEMBER_ID, B.FILE_NEW_NAME
				FROM (
					SELECT C.CLASS_NO, C.CLASS_TITLE, C.CLASS_DESC, C.CLASS_LOC, C.CLASS_CATEGORY, C.CLASS_PRICE,
					C.CLASS_SALE, C,CLASS_MEMBER_ID, F.FILE_NEW_NAME , ROW_NUMBER() OVER(PARTITION BY C.CLASS_NO ORDER BY F.FILE_NUM DESC) as RowIdx
					FROM CLASS C JOIN FILE_TABLE F
					ON C.CLASS_NO = F.CLASS_NO
					ORDER BY C.CLASS_NO DESC
					) B
				WHERE RowIdx = 1
				)A
			WHERE anum <![CDATA[ <= ]]>
			#{pageEnd}
			) X
		WHERE X.rnum <![CDATA[ >= ]]>
		#{pageBegin}	
	</select>
	
	<select id="classListCount">
		SELECT COUNT(CLASS_NO)
		FROM CLASS	
	</select>
	
	<select id="classListSearch">
	
	</select>
	
	<select id="classSearchCount">
	
	</select>
	
	
</mapper>
